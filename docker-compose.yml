version: '3.9'

services:

  # =====================================================
  # 1. ADMIN GROUP
  # =====================================================
  db:
    image: mysql:8.0
    container_name: dm_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: data_marketplace
      MYSQL_USER: dmuser
      MYSQL_PASSWORD: dmpass
    volumes:
      - ./db/init_admin_service.sql:/docker-entrypoint-initdb.d/init_admin_service.sql
    ports:
      - "3310:3306"
    networks:
      - admin_network
      - evnet # <-- thÃªm Ä‘á»ƒ dÃ¹ng chung DB khi cáº§n

  admin-service:
    build:
      context: ./admin
      dockerfile: Dockerfile
    container_name: admin_service
    restart: always
    depends_on:
      - db
    volumes:
      - ./admin/src:/var/www/html
    ports:
      - "8004:80"
    environment:
      DB_HOST: db
      DB_USER: dmuser
      DB_PASS: dmpass
      DB_NAME: data_marketplace

      PROVIDER_DB_HOST: db_provider # ðŸ‘ˆ DB cá»§a provider
      PROVIDER_DB_NAME: ev_data_marketplace
      PROVIDER_DB_USER: ev_user
      PROVIDER_DB_PASS: ev_pass

      ENCRYPT_KEY: change_this_32_chars_min
    networks:
      - admin_network
      - evnet # <-- Quan trá»ng! Ä‘á»ƒ gateway truy cáº­p Ä‘Æ°á»£c

    user: "33:33"

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:5.2.1
    container_name: admin_phpmyadmin
    restart: always
    environment:
      PMA_HOST: db
      PMA_USER: dmuser
      PMA_PASSWORD: dmpass
    ports:
      - "8081:80"
    depends_on:
      - db
    networks:
      - admin_network

  # =====================================================
  # 2. EV DATA ANALYTICS â€“ CONSUMER + PROVIDER
  # =====================================================
  provider:
    build:
      context: ./data-provider-service
      dockerfile: Dockerfile
    container_name: ev-provider
    ports:
      - "8008:80"
    volumes:
      - ./data-provider-service:/var/www/html
    environment:
      DB_HOST: db_provider # Äá»”I NÃˆ
      DB_NAME: ev_data_marketplace
      DB_USER: ev_user
      DB_PASS: ev_pass
    depends_on:
      - db_provider
    networks:
      - evnet

  consumer:
    build:
      context: ./data-consumer-service
      dockerfile: Dockerfile
    container_name: ev-consumer
    ports:
      - "8009:80"
    volumes:
      - ./data-consumer-service:/var/www/html
    environment:
      DB_HOST: db_consumer # Äá»”I NÃˆ
      DB_NAME: ev_analytics
      DB_USER: ev_user
      DB_PASS: ev_pass

      PROVIDER_DB_HOST: db_provider # ðŸ‘ˆ thÃªm
      PROVIDER_DB_NAME: ev_data_marketplace
      PROVIDER_DB_USER: ev_user
      PROVIDER_DB_PASS: ev_pass
    depends_on:
      - db_consumer
    networks:
      - evnet

  # DB cho PROVIDER
  db_provider:
    image: mysql:8.0
    container_name: ev-db-provider
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: ev_data_marketplace # DB chÃ­nh cho provider
      MYSQL_USER: ev_user
      MYSQL_PASSWORD: ev_pass
    ports:
      - "3307:3306" # Náº¿u cáº§n truy cáº­p tá»« ngoÃ i; náº¿u khÃ´ng cáº§n thÃ¬ cÃ³ thá»ƒ bá» luÃ´n dÃ²ng nÃ y
    volumes:
      - db_provider_data:/var/lib/mysql
      - ./database/provider_schema.sql:/docker-entrypoint-initdb.d/schema.sql
    networks:
      - evnet

  # DB cho CONSUMER
  db_consumer:
    image: mysql:8.0
    container_name: ev-db-consumer
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: ev_analytics # DB chÃ­nh cho consumer
      MYSQL_USER: ev_user
      MYSQL_PASSWORD: ev_pass
    ports:
      - "3308:3306" # Cá»•ng khÃ¡c 3307; cÅ©ng cÃ³ thá»ƒ bá» náº¿u chá»‰ dÃ¹ng ná»™i bá»™
    volumes:
      - db_consumer_data:/var/lib/mysql
      - ./database/consumer_schema.sql:/docker-entrypoint-initdb.d/schema.sql
    networks:
      - evnet

  # phpMyAdmin cho PROVIDER
  phpmyadmin_provider:
    image: phpmyadmin/phpmyadmin
    container_name: ev-phpmyadmin-provider
    environment:
      PMA_HOST: db_provider
      PMA_USER: root
      PMA_PASSWORD: root123
    ports:
      - "8082:80"
    depends_on:
      - db_provider
    networks:
      - evnet

  # phpMyAdmin cho CONSUMER
  phpmyadmin_consumer:
    image: phpmyadmin/phpmyadmin
    container_name: ev-phpmyadmin-consumer
    environment:
      PMA_HOST: db_consumer
      PMA_USER: root
      PMA_PASSWORD: root123
    ports:
      - "8083:80"
    depends_on:
      - db_consumer
    networks:
      - evnet

  # =====================================================
  # 3. GATEWAY + AUTH SERVICE
  # =====================================================

  gateway:
    build:
      context: ./gateway
    container_name: gateway
    ports:
      - "8006:80"
    volumes:
      - ./gateway:/var/www/html
    environment:
      DB_HOST: host.docker.internal
      DB_USER: root
      DB_PASS: ""
      DB_NAME: ev-data-analytics-marketplace
      DOCKER_ENV: "1"
    networks:
      - evnet

  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    ports:
      - "8007:80"
    volumes:
      - ./auth-service:/var/www/html
    environment:
      DB_HOST: host.docker.internal
      DB_USER: root
      DB_PASS: ""
      DB_NAME: ev-data-analytics-marketplace
      DOCKER_ENV: "1"
    networks:
      - evnet

# =====================================================
# NETWORKS + VOLUMES
# =====================================================
networks:
  admin_network:
    driver: bridge
  evnet:
    driver: bridge

volumes:
  db_data:
  db_provider_data:
  db_consumer_data:
